import unittest

import numpy as np
from numpy.testing import assert_almost_equal

import xarray as xr
# from xarray.testing as assert_all

import SAL_calculation as sc


class TestSAL(unittest.TestCase):
    def test_simple(self):
        field_a = np.array(
            [[0.3855761 , 0.66751653, 0.97202804, 1.20341314, 1.33805424,
              1.43500348, 1.51238079, 1.47880928, 1.25047275, 0.88312956,
              0.52561398],
             [0.44985605, 0.77968526, 1.15551783, 1.4983032 , 1.81466144,
              2.16671271, 2.4906857 , 2.55261273, 2.19215622, 1.53806109,
              0.88956581],
             [0.43816508, 0.74979302, 1.13173248, 1.55650783, 2.07803754,
              2.74373078, 3.37434901, 3.57354401, 3.10482464, 2.17749979,
              1.2460851 ],
             [0.37194473, 0.61535717, 0.94075606, 1.37666144, 2.01407375,
              2.8767075 , 3.70171811, 4.0014308 , 3.50578094, 2.46738075,
              1.4148799 ],
             [0.29768908, 0.46266596, 0.70122184, 1.06968894, 1.66358085,
              2.48705977, 3.2757056 , 3.57833843, 3.1556833 , 2.23941466,
              1.3040565 ],
             [0.24588716, 0.35179425, 0.50876481, 0.76735887, 1.19836447,
              1.79660008, 2.36607768, 2.58777425, 2.29710292, 1.65765983,
              0.99996507],
             [0.21815149, 0.29040752, 0.39013199, 0.54667963, 0.79799077,
              1.13725535, 1.45396148, 1.57409983, 1.40987816, 1.05126071,
              0.67801132],
             [0.20207875, 0.25810045, 0.32557779, 0.41543149, 0.54151373,
              0.69822502, 0.83688433, 0.88370669, 0.80259764, 0.63286113,
              0.45189432],
             [0.1869842 , 0.23475518, 0.28621353, 0.34253261, 0.40561981,
              0.47117413, 0.5215445 , 0.53205634, 0.49156504, 0.41451757,
              0.32846513],
             [0.16843504, 0.21028388, 0.25302646, 0.29441794, 0.33227288,
              0.36312401, 0.38085228, 0.37861944, 0.35418476, 0.31283266,
              0.2638999 ],
             [0.14629063, 0.18236307, 0.21857445, 0.2520841 , 0.27995864,
              0.29930794, 0.30740841, 0.30237136, 0.28429503, 0.25573574,
              0.22073832]]
        )
        
        field_b = np.array(
            [[0.01634776, 0.03854206, 0.0846338 , 0.145617  , 0.17912377,
              0.15568273, 0.10178001, 0.05822393, 0.03439059, 0.02127504,
              0.01264006],
             [0.04675786, 0.13199686, 0.32631213, 0.59132808, 0.73219808,
              0.61448908, 0.36576515, 0.17728438, 0.08827398, 0.0501906 ,
              0.02919183],
             [0.11367126, 0.3542025 , 0.92224917, 1.70520338, 2.11660804,
              1.75289196, 1.00348308, 0.44744965, 0.19915311, 0.10569701,
              0.0603104 ],
             [0.21512007, 0.67953611, 1.78101725, 3.30111163, 4.09876028,
              3.38897678, 1.9306889 , 0.8513419 , 0.37261845, 0.19551351,
              0.11118729],
             [0.31261932, 0.92112701, 2.3311675 , 4.26377903, 5.28552782,
              4.40864416, 2.57793433, 1.20438686, 0.57229025, 0.31665593,
              0.18282298],
             [0.37261845, 0.93920704, 2.16412032, 3.80688154, 4.69625682,
              4.02060696, 2.52818545, 1.3571118 , 0.75572152, 0.45518444,
              0.26868567],
             [0.40708134, 0.83795393, 1.6359473 , 2.64742251, 3.22970842,
              2.92958126, 2.11658346, 1.38966878, 0.91285125, 0.58944844,
              0.35372047],
             [0.43489703, 0.77193017, 1.27043173, 1.83774796, 2.20466919,
              2.17107914, 1.83823625, 1.42370426, 1.03239358, 0.6901239 ,
              0.417331  ],
             [0.44470327, 0.74478091, 1.12657666, 1.52118245, 1.80416235,
              1.87355609, 1.72681858, 1.43378938, 1.07633345, 0.72751389,
              0.44099558],
             [0.41763001, 0.6901239 , 1.02192624, 1.35372536, 1.6001981 ,
              1.68705653, 1.58973076, 1.34189799, 1.01512656, 0.68778706,
              0.41712823],
             [0.35313043, 0.58234975, 0.85949038, 1.13509092, 1.34103483,
              1.41724967, 1.34012653, 1.13406461, 0.85890034, 0.58214698,
              0.35308689]]
        )
        
        t = "xxx"
        
        # test with minimal output
        ds_sal = sc.SAL_timestep(
            field_a,
            field_b,
            time=t,
            params=["S","A","L"]
        )
        
        ds_sal_ref = xr.Dataset()
        ds_sal_ref["time"] = t
        ds_sal_ref["S"] = 0.25823206
        ds_sal_ref["A"] = -0.02740616
        ds_sal_ref["L"] = 0.17805914
        
        xr.testing.assert_allclose(
            ds_sal,
            ds_sal_ref)
        
        
    def test_timeseries(self):
        
        fields_a = np.array(
            [[[0.3855761 , 0.66751653, 0.97202804, 1.20341314, 1.33805424,
             1.43500348, 1.51238079, 1.47880928, 1.25047275, 0.88312956,
             0.52561398],
            [0.44985605, 0.77968526, 1.15551783, 1.4983032 , 1.81466144,
             2.16671271, 2.4906857 , 2.55261273, 2.19215622, 1.53806109,
             0.88956581],
            [0.43816508, 0.74979302, 1.13173248, 1.55650783, 2.07803754,
             2.74373078, 3.37434901, 3.57354401, 3.10482464, 2.17749979,
             1.2460851 ],
            [0.37194473, 0.61535717, 0.94075606, 1.37666144, 2.01407375,
             2.8767075 , 3.70171811, 4.0014308 , 3.50578094, 2.46738075,
             1.4148799 ],
            [0.29768908, 0.46266596, 0.70122184, 1.06968894, 1.66358085,
             2.48705977, 3.2757056 , 3.57833843, 3.1556833 , 2.23941466,
             1.3040565 ],
            [0.24588716, 0.35179425, 0.50876481, 0.76735887, 1.19836447,
             1.79660008, 2.36607768, 2.58777425, 2.29710292, 1.65765983,
             0.99996507],
            [0.21815149, 0.29040752, 0.39013199, 0.54667963, 0.79799077,
             1.13725535, 1.45396148, 1.57409983, 1.40987816, 1.05126071,
             0.67801132],
            [0.20207875, 0.25810045, 0.32557779, 0.41543149, 0.54151373,
             0.69822502, 0.83688433, 0.88370669, 0.80259764, 0.63286113,
             0.45189432],
            [0.1869842 , 0.23475518, 0.28621353, 0.34253261, 0.40561981,
             0.47117413, 0.5215445 , 0.53205634, 0.49156504, 0.41451757,
             0.32846513],
            [0.16843504, 0.21028388, 0.25302646, 0.29441794, 0.33227288,
             0.36312401, 0.38085228, 0.37861944, 0.35418476, 0.31283266,
             0.2638999 ],
            [0.14629063, 0.18236307, 0.21857445, 0.2520841 , 0.27995864,
             0.29930794, 0.30740841, 0.30237136, 0.28429503, 0.25573574,
             0.22073832]],

           [[5.19278805, 5.33375826, 5.48601402, 5.60170657, 5.66902712,
             5.71750174, 5.7561904 , 5.73940464, 5.62523638, 5.44156478,
             5.26280699],
            [5.22492802, 5.38984263, 5.57775891, 5.7491516 , 5.90733072,
             6.08335636, 6.24534285, 6.27630636, 6.09607811, 5.76903054,
             5.4447829 ],
            [5.21908254, 5.37489651, 5.56586624, 5.77825392, 6.03901877,
             6.37186539, 6.6871745 , 6.786772  , 6.55241232, 6.0887499 ,
             5.62304255],
            [5.18597236, 5.30767858, 5.47037803, 5.68833072, 6.00703687,
             6.43835375, 6.85085905, 7.0007154 , 6.75289047, 6.23369037,
             5.70743995],
            [5.14884454, 5.23133298, 5.35061092, 5.53484447, 5.83179043,
             6.24352988, 6.6378528 , 6.78916921, 6.57784165, 6.11970733,
             5.65202825],
            [5.12294358, 5.17589713, 5.25438241, 5.38367943, 5.59918224,
             5.89830004, 6.18303884, 6.29388712, 6.14855146, 5.82882991,
             5.49998253],
            [5.10907575, 5.14520376, 5.19506599, 5.27333981, 5.39899538,
             5.56862767, 5.72698074, 5.78704992, 5.70493908, 5.52563035,
             5.33900566],
            [5.10103937, 5.12905023, 5.16278889, 5.20771575, 5.27075687,
             5.34911251, 5.41844217, 5.44185335, 5.40129882, 5.31643056,
             5.22594716],
            [5.0934921 , 5.11737759, 5.14310677, 5.1712663 , 5.20280991,
             5.23558706, 5.26077225, 5.26602817, 5.24578252, 5.20725878,
             5.16423257],
            [5.08421752, 5.10514194, 5.12651323, 5.14720897, 5.16613644,
             5.181562  , 5.19042614, 5.18930972, 5.17709238, 5.15641633,
             5.13194995],
            [5.07314531, 5.09118153, 5.10928723, 5.12604205, 5.13997932,
             5.14965397, 5.15370421, 5.15118568, 5.14214751, 5.12786787,
             5.11036916]]]
        )
        
        
        fields_b = np.array(
            [[[0.01634776, 0.03854206, 0.0846338 , 0.145617  , 0.17912377,
             0.15568273, 0.10178001, 0.05822393, 0.03439059, 0.02127504,
             0.01264006],
            [0.04675786, 0.13199686, 0.32631213, 0.59132808, 0.73219808,
             0.61448908, 0.36576515, 0.17728438, 0.08827398, 0.0501906 ,
             0.02919183],
            [0.11367126, 0.3542025 , 0.92224917, 1.70520338, 2.11660804,
             1.75289196, 1.00348308, 0.44744965, 0.19915311, 0.10569701,
             0.0603104 ],
            [0.21512007, 0.67953611, 1.78101725, 3.30111163, 4.09876028,
             3.38897678, 1.9306889 , 0.8513419 , 0.37261845, 0.19551351,
             0.11118729],
            [0.31261932, 0.92112701, 2.3311675 , 4.26377903, 5.28552782,
             4.40864416, 2.57793433, 1.20438686, 0.57229025, 0.31665593,
             0.18282298],
            [0.37261845, 0.93920704, 2.16412032, 3.80688154, 4.69625682,
             4.02060696, 2.52818545, 1.3571118 , 0.75572152, 0.45518444,
             0.26868567],
            [0.40708134, 0.83795393, 1.6359473 , 2.64742251, 3.22970842,
             2.92958126, 2.11658346, 1.38966878, 0.91285125, 0.58944844,
             0.35372047],
            [0.43489703, 0.77193017, 1.27043173, 1.83774796, 2.20466919,
             2.17107914, 1.83823625, 1.42370426, 1.03239358, 0.6901239 ,
             0.417331  ],
            [0.44470327, 0.74478091, 1.12657666, 1.52118245, 1.80416235,
             1.87355609, 1.72681858, 1.43378938, 1.07633345, 0.72751389,
             0.44099558],
            [0.41763001, 0.6901239 , 1.02192624, 1.35372536, 1.6001981 ,
             1.68705653, 1.58973076, 1.34189799, 1.01512656, 0.68778706,
             0.41712823],
            [0.35313043, 0.58234975, 0.85949038, 1.13509092, 1.34103483,
             1.41724967, 1.34012653, 1.13406461, 0.85890034, 0.58214698,
             0.35308689]],

           [[8.00544925, 8.01284735, 8.02821127, 8.048539  , 8.05970792,
             8.05189424, 8.03392667, 8.01940798, 8.01146353, 8.00709168,
             8.00421335],
            [8.01558595, 8.04399895, 8.10877071, 8.19710936, 8.24406603,
             8.20482969, 8.12192172, 8.05909479, 8.02942466, 8.0167302 ,
             8.00973061],
            [8.03789042, 8.1180675 , 8.30741639, 8.56840113, 8.70553601,
             8.58429732, 8.33449436, 8.14914988, 8.06638437, 8.03523234,
             8.02010347],
            [8.07170669, 8.22651204, 8.59367242, 9.10037054, 9.36625343,
             9.12965893, 8.64356297, 8.28378063, 8.12420615, 8.06517117,
             8.03706243],
            [8.10420644, 8.30704234, 8.77705583, 9.42125968, 9.76184261,
             9.46954805, 8.85931144, 8.40146229, 8.19076342, 8.10555198,
             8.06094099],
            [8.12420615, 8.31306901, 8.72137344, 9.26896051, 9.56541894,
             9.34020232, 8.84272848, 8.4523706 , 8.25190717, 8.15172815,
             8.08956189],
            [8.13569378, 8.27931798, 8.54531577, 8.88247417, 9.07656947,
             8.97652709, 8.70552782, 8.46322293, 8.30428375, 8.19648281,
             8.11790682],
            [8.14496568, 8.25731006, 8.42347724, 8.61258265, 8.73488973,
             8.72369305, 8.61274542, 8.47456809, 8.34413119, 8.2300413 ,
             8.13911033],
            [8.14823442, 8.2482603 , 8.37552555, 8.50706082, 8.60138745,
             8.6245187 , 8.57560619, 8.47792979, 8.35877782, 8.24250463,
             8.14699853],
            [8.13921   , 8.2300413 , 8.34064208, 8.45124179, 8.53339937,
             8.56235218, 8.52991025, 8.44729933, 8.33837552, 8.22926235,
             8.13904274],
            [8.11771014, 8.19411658, 8.28649679, 8.37836364, 8.44701161,
             8.47241656, 8.44670884, 8.37802154, 8.28630011, 8.19404899,
             8.11769563]]]
        )
        
        t_array=['xxx', 'yyy']
        
        # as datasets
        ds_a = xr.Dataset()
        ds_a['fields'] = (('time','y','x'), fields_a)
        ds_a['time'] = ('time', t_array)

        ds_b = xr.Dataset()
        ds_b['fields'] = (('time','y','x'), fields_b)
        ds_b['time'] = ('time', t_array)
        
        ds_sal = sc.SAL_timeseries(
            ds_a.fields,
            ds_b.fields,
            t_array=t_array,
        )
        
        ds_sal_ref = xr.Dataset()
        ds_sal_ref = ds_sal_ref.assign_coords({"time": t_array})
        ds_sal_ref["S"] = ("time", [0.25823206, -0.07818079])
        ds_sal_ref["A"] = ("time", [-0.02740616, -0.40501276])
        ds_sal_ref["L"] = ("time", [0.17805914, 0.0149411])
        ds_sal_ref["L1"] = ("time", [0.17707402, 0.0149411])
        ds_sal_ref["thld_sim"] = ("time", [0.21838037, 0.44252352])
        ds_sal_ref["thld_ref"] = ("time", [0.2537921, 0.6179307])
        ds_sal_ref["nF_sim"] = ("time", [1, 1])
        ds_sal_ref["nF_ref"] = ("time", [1, 1])
        ds_sal_ref["tcm_y_sim"] = ("time", [3.52119429, 4.85104918])
        ds_sal_ref["tcm_x_sim"] = ("time", [5.95379256, 5.09606954])
        ds_sal_ref["tcm_y_ref"] = ("time", [5.58611338, 5.02682657])
        ds_sal_ref["tcm_x_ref"] = ("time", [4.53705307, 4.9788108])
        ds_sal_ref["Q"] = ("time", [0.31486497, 0.41275999])
        
        xr.testing.assert_allclose(
            ds_sal,
            ds_sal_ref)
        
        
    def test_ensemble(self):



        fields_a = np.array(
            [[[0.60541402, 0.96832183, 1.3670752 , 1.65892416, 1.74638216,
             1.64965615, 1.45859754, 1.24099162, 1.0173934 , 0.79414455,
             0.58686915],
            [0.76358878, 1.25489853, 1.78758887, 2.15788264, 2.23301746,
             2.05461729, 1.76410851, 1.46430836, 1.18067676, 0.91151576,
             0.667151  ],
            [0.8318795 , 1.37704708, 1.96549196, 2.36756878, 2.43579981,
             2.2213511 , 1.88798531, 1.55358897, 1.24556404, 0.95841906,
             0.69980545],
            [0.77264773, 1.26482882, 1.79825442, 2.16910647, 2.2445902 ,
             2.06630872, 1.77568124, 1.47553219, 1.19134231, 0.92144606,
             0.67620995],
            [0.62298936, 0.98758767, 1.38776751, 1.6806996 , 1.7688345 ,
             1.67233877, 1.48104988, 1.26276705, 1.03808571, 0.81341039,
             0.60444449],
            [0.45857807, 0.68642414, 0.94161621, 1.14438294, 1.23502974,
             1.21435654, 1.1217426 , 0.9900992 , 0.83413053, 0.66624332,
             0.50505319],
            [0.33176986, 0.45864909, 0.60387119, 0.73109667, 0.8086824 ,
             0.82800401, 0.79770853, 0.72853288, 0.62994779, 0.51521685,
             0.40131483],
            [0.25103937, 0.3194707 , 0.39833423, 0.47339064, 0.52927383,
             0.55653236, 0.55225345, 0.51777112, 0.45869917, 0.38541269,
             0.31035155],
            [0.20157977, 0.24055822, 0.28423566, 0.32726896, 0.36242165,
             0.38304281, 0.38478913, 0.36669425, 0.33187341, 0.28690998,
             0.23949136],
            [0.168084  , 0.19264557, 0.21843959, 0.24322929, 0.26358576,
             0.27577224, 0.27694105, 0.26623971, 0.24532196, 0.21781721,
             0.18793713],
            [0.14197738, 0.15906698, 0.1756576 , 0.19059552, 0.20220852,
             0.20864795, 0.20849064, 0.20133662, 0.18805907, 0.17051666,
             0.15088179]],

           [[2.20180467, 2.32277394, 2.45569173, 2.55297472, 2.58212739,
             2.54988538, 2.48619918, 2.41366387, 2.33913113, 2.26471485,
             2.19562305],
            [2.25452959, 2.41829951, 2.59586296, 2.71929421, 2.74433915,
             2.68487243, 2.58803617, 2.48810279, 2.39355892, 2.30383859,
             2.22238367],
            [2.27729317, 2.45901569, 2.65516399, 2.78918959, 2.81193327,
             2.74045037, 2.62932844, 2.51786299, 2.41518801, 2.31947302,
             2.23326848],
            [2.25754924, 2.42160961, 2.59941814, 2.72303549, 2.74819673,
             2.68876957, 2.59189375, 2.49184406, 2.3971141 , 2.30714869,
             2.22540332],
            [2.20766312, 2.32919589, 2.46258917, 2.5602332 , 2.5896115 ,
             2.55744626, 2.49368329, 2.42092235, 2.34602857, 2.2711368 ,
             2.2014815 ],
            [2.15285936, 2.22880805, 2.31387207, 2.38146098, 2.41167658,
             2.40478551, 2.3739142 , 2.33003307, 2.27804351, 2.22208111,
             2.16835106],
            [2.11058995, 2.15288303, 2.2012904 , 2.24369889, 2.2695608 ,
             2.27600134, 2.26590284, 2.24284429, 2.2099826 , 2.17173895,
             2.13377161],
            [2.08367979, 2.10649023, 2.13277808, 2.15779688, 2.17642461,
             2.18551079, 2.18408448, 2.17259037, 2.15289972, 2.1284709 ,
             2.10345052],
            [2.06719326, 2.08018607, 2.09474522, 2.10908965, 2.12080722,
             2.12768094, 2.12826304, 2.12223142, 2.11062447, 2.09563666,
             2.07983045],
            [2.056028  , 2.06421519, 2.0728132 , 2.08107643, 2.08786192,
             2.09192408, 2.09231368, 2.08874657, 2.08177399, 2.07260574,
             2.06264571],
            [2.04732579, 2.05302233, 2.05855253, 2.06353184, 2.06740284,
             2.06954932, 2.06949688, 2.06711221, 2.06268636, 2.05683889,
             2.05029393]]]
        )
        
        
        fields_b = np.array(
            [[[0.33093684, 0.38179966, 0.41988771, 0.44058395, 0.44201326,
             0.42515236, 0.39311487, 0.35012952, 0.30068539, 0.24900254,
             0.19872978],
            [0.38424784, 0.44459421, 0.48659838, 0.50456602, 0.49756815,
             0.4690583 , 0.42499472, 0.37172198, 0.31463999, 0.25785999,
             0.20440771],
            [0.46700566, 0.54254597, 0.5898171 , 0.60133026, 0.57808207,
             0.52821974, 0.46297493, 0.39250179, 0.32368283, 0.26017175,
             0.2035839 ],
            [0.59515808, 0.69447338, 0.7494759 , 0.74983434, 0.69976591,
             0.61512986, 0.51577206, 0.41802036, 0.33108902, 0.25777233,
             0.19727001],
            [0.77491103, 0.90764697, 0.97336888, 0.95773963, 0.86956411,
             0.73564949, 0.58805639, 0.45185298, 0.33953474, 0.2526461 ,
             0.18693025],
            [0.99116576, 1.16414105, 1.24270387, 1.20768952, 1.0734532 ,
             0.8800309 , 0.67423671, 0.49168967, 0.34883744, 0.24570117,
             0.17383551],
            [1.20272216, 1.41518275, 1.5061007 , 1.45155749, 1.2714544 ,
             1.01898495, 0.75561445, 0.52741729, 0.35472494, 0.23599486,
             0.15857134],
            [1.35180375, 1.59242069, 1.69147486, 1.6216121 , 1.40696267,
             1.11058803, 0.80488012, 0.54364972, 0.35001341, 0.2211241 ,
             0.14104792],
            [1.38718759, 1.63526273, 1.73491383, 1.65777082, 1.42971796,
             1.11755309, 0.79766993, 0.52657784, 0.32816723, 0.19880733,
             0.12105837],
            [1.28908855, 1.52028104, 1.61174822, 1.53695544, 1.32059582,
             1.02593136, 0.72515348, 0.47151007, 0.28729821, 0.16873996,
             0.09900867],
            [1.07993539, 1.27394435, 1.35000812, 1.28581269, 1.10236133,
             0.85324015, 0.59952188, 0.38617889, 0.23193817, 0.13343473,
             0.0762649 ]],

           [[6.16546842, 6.19089983, 6.20994386, 6.22029198, 6.22100663,
             6.21257618, 6.19655743, 6.17506476, 6.1503427 , 6.12450127,
             6.09936489],
            [6.19212392, 6.2222971 , 6.24329919, 6.25228301, 6.24878408,
             6.23452915, 6.21249736, 6.18586099, 6.15732   , 6.12893   ,
             6.10220386],
            [6.23350283, 6.27127299, 6.29490855, 6.30066513, 6.28904104,
             6.26410987, 6.23148746, 6.19625089, 6.16184142, 6.13008587,
             6.10179195],
            [6.29757904, 6.34723669, 6.37473795, 6.37491717, 6.34988296,
             6.30756493, 6.25788603, 6.20901018, 6.16554451, 6.12888616,
             6.098635  ],
            [6.38745551, 6.45382348, 6.48668444, 6.47886982, 6.43478205,
             6.36782474, 6.2940282 , 6.22592649, 6.16976737, 6.12632305,
             6.09346512],
            [6.49558288, 6.58207052, 6.62135194, 6.60384476, 6.5367266 ,
             6.44001545, 6.33711836, 6.24584484, 6.17441872, 6.12285058,
             6.08691775],
            [6.60136108, 6.70759138, 6.75305035, 6.72577875, 6.6357272 ,
             6.50949248, 6.37780723, 6.26370865, 6.17736247, 6.11799743,
             6.07928567],
            [6.67590187, 6.79621035, 6.84573743, 6.81080605, 6.70348133,
             6.55529401, 6.40244006, 6.27182486, 6.1750067 , 6.11056205,
             6.07052396],
            [6.6935938 , 6.81763137, 6.86745692, 6.82888541, 6.71485898,
             6.55877654, 6.39883497, 6.26328892, 6.16408361, 6.09940366,
             6.06052918],
            [6.64454427, 6.76014052, 6.80587411, 6.76847772, 6.66029791,
             6.51296568, 6.36257674, 6.23575504, 6.1436491 , 6.08436998,
             6.04950433],
            [6.53996769, 6.63697217, 6.67500406, 6.64290634, 6.55118066,
             6.42662007, 6.29976094, 6.19308944, 6.11596908, 6.06671737,
             6.03813245]]]
        )
        
        t = "xxx"
        
        # ==============
        # first test
        ds_sal = sc.SAL_timestep(
            fields_a,
            fields_b,
            time=t,
            params=['S','A','L'],
            memberinfo=True
        )
        
        ds_sal_ref = xr.Dataset()
        ds_sal_ref["time"] = t
        ds_sal_ref["S"] = -0.074708
        ds_sal_ref["mS"] = ("nfields_sim", [-0.5560225 ,  0.25406258])
        ds_sal_ref["A"] = -0.76011114
        ds_sal_ref["mA"] = ("nfields_sim", [-1.20438418, -0.42403053])
        ds_sal_ref["L"] = 0.13889447
        ds_sal_ref["mL"] = ("nfields_sim", [0.16345405, 0.07461948])
        
        xr.testing.assert_allclose(
            ds_sal,
            ds_sal_ref)
        
        # ==============
        # second test with fixed thld
        ds_sal = sc.SAL_timestep(
            fields_a,
            fields_b,
            time=t,
            fixed_thld=0.1,
            params=['S','A','L'],
            memberinfo=True
        )
        
        ds_sal_ref = xr.Dataset()
        ds_sal_ref["time"] = t
        ds_sal_ref["S"] = -0.1222824
        ds_sal_ref["mS"] = ("nfields_sim", [-0.59498895,  0.2047438])
        ds_sal_ref["A"] = -0.76011114
        ds_sal_ref["mA"] = ("nfields_sim", [-1.20438418, -0.42403053])
        ds_sal_ref["L"] = 0.11164241
        ds_sal_ref["mL"] = ("nfields_sim", [0.15996997, 0.0711354])
        
        xr.testing.assert_allclose(
            ds_sal,
            ds_sal_ref)